# MyTab 云端同步使用指南

## 功能说明

新增的云端数据同步功能可以智能地检测云端是否有更新的数据，并提供安全的同步机制。

## 主要功能

### 1. 自动检查云端更新
- **启动检查**：每次打开插件时自动检查云端是否有更新数据
- **智能频率控制**：切换标签页时最多每5分钟检查一次，避免频繁请求
- **条件检查**：只有在配置了WebDAV且启用备份时才会检查

### 2. 安全的同步机制
- **同步前备份**：同步前自动备份当前本地数据，使用特殊前缀 `sync_backup_`
- **智能版本比较**：忽略同步备份文件，只比较真实的数据快照
- **覆盖式同步**：下载云端数据完全替换本地数据
- **时间戳更新**：同步后更新本地数据的时间戳

### 3. 用户友好的界面
- **美观的提示弹窗**：显示云端文件信息和时间对比
- **明确的操作提示**：告知用户会先备份本地数据
- **实时反馈**：显示同步进度和结果

## 使用方法

### 自动同步
1. 确保已配置WebDAV服务器信息
2. 启用自动备份功能
3. 打开插件时会自动检查云端更新
4. 如有更新，会弹出同步提示
5. 点击"立即同步"即可同步云端数据

### 手动检查
1. 打开设置页面（点击齿轮图标）
2. 在"自动备份"区域点击"检查云端更新"按钮
3. 系统会检查云端是否有更新数据
4. 如有更新，会提示是否同步

## 配置要求

### WebDAV 配置
- **URL**：WebDAV服务器地址，如 `https://dav.example.com/remote.php/dav/files/username/mytab/`
- **用户名**：WebDAV账户用户名
- **密码**：WebDAV账户密码

### 备份设置
- **开启自动备份**：必须启用才能使用云端同步功能
- **频率**：建议设置合适的备份频率（如4小时）
- **历史上限**：控制云端保留的备份文件数量

## 使用场景

### 多设备同步
1. **设备A**：添加新书签，自动备份到云端
2. **设备B**：打开插件，检测到云端更新
3. **设备B**：选择同步，先备份本地数据，再下载云端数据
4. **结果**：两设备数据保持一致

### 数据恢复
1. 本地数据意外丢失或损坏
2. 打开插件，检测到云端有备份数据
3. 选择同步，恢复云端数据到本地

## 注意事项

### 数据安全
- 同步前会自动备份当前本地数据
- 备份文件使用特殊前缀，不会干扰版本比较
- 网络异常时同步失败，本地数据不会丢失

### 版本管理
- 系统会比较本地和云端数据的时间戳
- 只有云端数据更新时才会提示同步
- 同步备份文件不参与版本比较

### 性能优化
- 检查频率有限制，避免频繁网络请求
- 只在必要时才显示同步提示
- 同步过程有进度反馈

## 故障排除

### 检查不到云端更新
1. 确认WebDAV配置正确
2. 确认已启用自动备份
3. 检查网络连接
4. 手动点击"检查云端更新"按钮

### 同步失败
1. 检查WebDAV服务器连接
2. 确认有足够的存储空间
3. 检查用户权限设置
4. 查看浏览器控制台错误信息

### 数据不一致
1. 检查各设备的时间设置
2. 确认所有设备都使用相同的WebDAV配置
3. 手动触发备份和同步

## 技术细节

### 文件命名规则
- 普通备份：`snapshot_schedule_`, `snapshot_user_`, `snapshot_handle_`
- 同步备份：`sync_backup_` （不参与版本比较）

### 时间戳机制
- 本地数据：使用 `lastModified` 字段记录最后修改时间
- 云端文件：使用文件的最后修改时间
- 比较逻辑：云端时间 > 本地时间 = 有更新

### 数据结构
```json
{
  "version": 1,
  "ts": 1642000000000,
  "data": {
    "folders": [...],
    "backgroundImage": "...",
    "lastModified": 1642000000000,
    "syncedFrom": "snapshot_user_2024-01-15T10-30-00-000Z.json",
    "syncedAt": "2024-01-15T10:30:00.000Z"
  }
}
```