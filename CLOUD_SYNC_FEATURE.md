# 云端数据同步功能

## 功能概述

新增的云端数据同步功能会在插件启动时自动检查云端是否有更新的数据，如果发现云端数据比本地数据更新，会提示用户是否需要同步。

## 主要特性

### 1. 自动检查
- 插件启动时自动检查云端数据
- 用户打开新标签页时也会检查（限制频率：每5分钟最多一次）

### 2. 智能比较
- 比较本地数据和云端数据的时间戳
- 忽略同步备份文件（`sync_backup_` 前缀），避免备份数据干扰版本比较
- 只比较真实的数据快照文件

### 3. 安全同步
- 同步前自动备份当前本地数据（使用 `sync_backup_` 前缀）
- 这个备份只是为了防止同步失败导致数据丢失，不会影响版本比较
- 下载云端数据并覆盖本地数据
- 添加同步时间戳和来源信息

### 4. 用户友好的界面
- 美观的同步提示弹窗
- 显示云端文件名、云端时间、本地时间
- 明确提示会先备份本地数据
- 提供"稍后再说"和"立即同步"选项

## 技术实现

### 后台服务 (service_worker.js)
- `checkCloudDataOnStartup()`: 检查云端数据是否更新
- `getLocalDataTimestamp()`: 获取本地数据时间戳
- `syncFromCloud()`: 执行同步操作
- 修改 `doBackup()` 支持同步备份类型

### 前端界面 (app.js)
- `checkCloudDataAndPrompt()`: 检查并提示用户
- `showSyncPrompt()`: 显示同步确认弹窗
- `syncFromCloudWithFeedback()`: 执行同步并显示反馈

### 数据存储 (storage.js)
- 所有数据修改操作都会更新 `lastModified` 时间戳
- 确保本地数据变更能被正确追踪

## 使用场景

### 场景1：多设备同步
1. 设备A新增书签，自动备份到云端（版本1）
2. 设备B打开插件，检测到云端有更新数据
3. 设备B提示用户同步，用户确认后：
   - 先备份设备B的当前数据（sync_backup前缀）
   - 下载设备A的数据（版本1）
   - 更新设备B的本地数据

### 场景2：避免备份干扰
1. 设备A有数据版本1，备份到云端
2. 设备B本地是版本0，从云端同步前先备份版本0
3. 设备A再次打开时，不会被版本0的备份干扰，因为备份文件被忽略

## 配置要求

- 需要配置WebDAV服务器信息
- 确保WebDAV服务器可读写访问
- 建议启用自动备份功能

## 注意事项

1. 同步是覆盖式的，会完全替换本地数据
2. 同步前的备份使用特殊前缀，不会影响版本比较
3. 网络异常时同步可能失败，本地数据不会丢失
4. 频繁的标签页切换不会触发过多检查（有频率限制）